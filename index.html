<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>One-click Website → Android App (APK or PWA fallback)</title>
<style>
  body{font-family:Inter,system-ui,Arial;margin:20px;background:#f4f7fb;color:#0b1723}
  h1{font-size:20px;margin:0 0 12px}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #cbd5e1;background:white}
  .row{display:flex;gap:10px;margin-top:10px}
  .row> *{flex:1}
  .note{font-size:13px;color:#475569;margin-top:8px}
  .output{margin-top:14px;padding:12px;border-radius:8px;background:#fff;border:1px solid #e6eefc}
  button{cursor:pointer;background:#2563eb;color:white;border:none;font-weight:700}
  .muted{color:#6b7280}
  small{display:block;margin-top:6px;color:#6b7280}
  .danger{background:#ef4444}
  .hidden{display:none}
</style>
</head>
<body>
  <h1>One-click Website → Android App (APK if possible, otherwise PWA ZIP)</h1>

  <label>Website URL (include https://)</label>
  <input id="siteUrl" placeholder="https://example.com" value="https://chesskit.org">

  <label>App name (optional)</label>
  <input id="appName" placeholder="My Website App">

  <label>Package ID (optional, example: com.example.myapp)</label>
  <input id="pkgId" placeholder="com.example.myapp">

  <div class="row">
    <div><button id="buildBtn">Generate Android App</button></div>
    <div><button id="previewBtn" class="danger">Preview Wrapper</button></div>
  </div>

  <div class="note">
    This tool will first try a third-party builder API (no local tools). If that fails (CORS/API key/etc.), it will create a downloadable PWA ZIP (index.html + manifest + sw.js) that you can host and <em>Add to Home screen</em> on Android. APK generation is attempted automatically but may fail if the remote API blocks browser requests.
  </div>

  <div id="output" class="output hidden"></div>

<script>
/* ---------- Utilities ---------- */
const $ = id => document.getElementById(id);
const setOutput = html => { const o=$('output'); o.innerHTML=html; o.classList.remove('hidden'); }
function sanitizeUrl(u){
  try{ const url = new URL(u); return url.href; }catch(e){ return null; }
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fileToArrayBuffer(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsArrayBuffer(f); }); }

/* ---------- PWA ZIP creator (fallback) ---------- */
async function createPwaZip(siteUrl, appName, includeIconFile) {
  // Uses JSZip loaded dynamically
  if(!window.JSZip){
    await new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js';
      s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
    });
  }
  const zip = new JSZip();
  const manifest = {
    name: appName || (new URL(siteUrl)).hostname,
    short_name: (appName||'App').slice(0,12),
    start_url: siteUrl,
    display: "standalone",
    background_color: "#ffffff",
    theme_color: "#2563eb",
    icons: []
  };
  if(includeIconFile) manifest.icons.push({src:'icon.png',sizes:'512x512',type:'image/png'});
  const indexHtml = `<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="/manifest.json"><title>${escapeHtml(manifest.name)}</title>
<style>html,body{height:100%;margin:0}iframe{border:0;position:fixed;inset:0;width:100%;height:100%}</style>
</head><body><iframe src="${escapeHtml(siteUrl)}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
<script>if('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});</script></body></html>`;
  const swJs = `const CACHE='pwa-shell-v1';self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/','/index.html','/manifest.json','/sw.js']).catch(()=>{})));});
self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));
self.addEventListener('fetch',e=>{ if(e.request.mode==='navigate'){ e.respondWith(fetch(e.request).catch(()=>caches.match('/index.html'))); return;} e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))); });`;
  zip.file('index.html', indexHtml);
  zip.file('manifest.json', JSON.stringify(manifest,null,2));
  zip.file('sw.js', swJs);
  if(includeIconFile){
    try{
      const ab = await fileToArrayBuffer(includeIconFile);
      zip.file('icon.png', ab);
    }catch(e){}
  }
  zip.file('README.txt', `This package is a Progressive Web App wrapper for ${siteUrl}.\nUnzip and host the files on HTTPS. Open hosted URL in Android Chrome and choose "Add to Home screen".`);
  const blob = await zip.generateAsync({type:'blob',compression:'DEFLATE'});
  return blob;
}

/* ---------- Build flow ---------- */
$('buildBtn').onclick = async ()=>{
  setOutput('Starting build...<br><small class="muted">Attempting APK generation with public builder API, then fallback to PWA ZIP if needed.</small>');
  const rawUrl = $('siteUrl').value.trim();
  const siteUrl = sanitizeUrl(rawUrl);
  if(!siteUrl){ setOutput('Invalid URL — include https://'); return; }
  const appName = $('appName').value.trim() || '';
  const pkgId = $('pkgId').value.trim() || '';

  // 1) Try a public third-party builder (attempt PWABuilder’s CloudAPK endpoint)
  // Note: This endpoint may enforce CORS or require an API key. We try once.
  const cloudapkEndpoint = 'https://cloudapk.azurewebsites.net/generateAppPackage';
  const payload = {
    webManifestUrl: siteUrl, // many builders accept manifest URL or site URL
    appVersion: "1.0.0",
    appVersionCode: 1,
    packageId: pkgId || ('com.site.' + (new URL(siteUrl)).hostname.replace(/\./g,'_')),
    signingMode: "none",
    features: {},
    fallbackType: "customtabs"
  };

  try {
    setOutput('Requesting APK build from builder service (this may take up to a minute)...');
    const resp = await fetch(cloudapkEndpoint, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    if(!resp.ok){
      // Builder returned error — fall back
      const text = await resp.text().catch(()=>resp.statusText);
      throw new Error('Builder API returned ' + resp.status + ': ' + text);
    }

    // If we get here, builder responded with a blob (zip)
    const blob = await resp.blob();
    // Offer download
    const dlUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = dlUrl;
    a.download = `${(appName||'app')}_build.zip`;
    a.textContent = 'Download APK/AAB ZIP — click to save';
    a.style.display='inline-block';
    setOutput('<strong>Build ready:</strong><br>');
    $('output').appendChild(a);
    $('output').appendChild(document.createElement('br'));
    $('output').appendChild(document.createTextNode('If the file does not contain an APK/AAB, the builder may have returned a different payload.'));
    return;
  } catch(err) {
    // Fall back to PWA ZIP creation
    console.warn('APK build failed or blocked:', err);
    setOutput('APK build attempt failed or blocked by the builder service. Creating a PWA ZIP fallback now (works without remote services) ...');
    try {
      // Create PWA ZIP (no icon upload implemented to keep single-file)
      // Ask user if they want to provide an icon (optional)
      const includeIcon = confirm("APK build failed. Would you like to include a custom icon (512x512 PNG)? Click OK to upload, Cancel to continue without icon.");
      let iconFile = null;
      if(includeIcon){
        // create an invisible file input to let user pick
        const inp = document.createElement('input');
        inp.type='file'; inp.accept='image/*';
        inp.style.display='none';
        document.body.appendChild(inp);
        await new Promise(res => {
          inp.onchange = ()=>res();
          inp.click();
        });
        if(inp.files && inp.files[0]) iconFile = inp.files[0];
        document.body.removeChild(inp);
      }
      const pwaBlob = await createPwaZip(siteUrl, appName || (new URL(siteUrl)).hostname, iconFile);
      const pwaUrl = URL.createObjectURL(pwaBlob);
      const a = document.createElement('a');
      a.href = pwaUrl;
      a.download = `${(appName||'pwa').replace(/[^a-z0-9]/ig,'_')}_pwa.zip`;
      a.textContent = 'Download PWA ZIP (fallback) — unzip and host on HTTPS';
      a.style.display='inline-block';
      setOutput('<strong>PWA ZIP ready:</strong><br>');
      $('output').appendChild(a);
      $('output').appendChild(document.createElement('br'));
      const info = document.createElement('div');
      info.innerHTML = `<small class="muted">To install: unzip & upload to HTTPS static host (GitHub Pages/Netlify). Open hosted URL on Android Chrome → menu → "Add to Home screen".</small>`;
      $('output').appendChild(info);
    } catch(e2){
      setOutput('Failed to create fallback PWA ZIP: ' + e2.message);
    }
  }
};

/* ---------- Preview button: shows the wrapper locally ---------- */
$('previewBtn').onclick = ()=>{
  const rawUrl = $('siteUrl').value.trim();
  const siteUrl = sanitizeUrl(rawUrl);
  if(!siteUrl){ setOutput('Invalid URL — include https://'); return; }
  const name = $('appName').value.trim() || new URL(siteUrl).hostname;
  const html = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${escapeHtml(name)}</title>
  <style>html,body{height:100%;margin:0}iframe{border:0;position:fixed;inset:0;width:100%;height:100%}</style></head><body>
  <iframe src="${escapeHtml(siteUrl)}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe></body></html>`;
  const b = new Blob([html],{type:'text/html'});
  const u = URL.createObjectURL(b);
  window.open(u,'_blank');
};
</script>
</body>
</html>
