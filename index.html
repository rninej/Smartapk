<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Website → Android App Generator</title>
<style>
  body{font-family:Inter,system-ui,Arial;margin:20px;background:#f4f7fb;color:#0b1723}
  h1{font-size:22px;margin:0 0 12px}
  label{display:block;margin-top:10px;font-weight:600}
  input,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #cbd5e1;background:white}
  button{cursor:pointer;background:#2563eb;color:white;border:none;font-weight:700}
  .note{font-size:13px;color:#475569;margin-top:8px}
  .output{margin-top:14px;padding:12px;border-radius:8px;background:#fff;border:1px solid #e6eefc}
  .hidden{display:none}
</style>
</head>
<body>
  <h1>Convert Your Website into an Android App</h1>
  <label>Website URL (include https://)</label>
  <input id="siteUrl" placeholder="https://example.com" value="https://chesskit.org">
  <label>App name (optional)</label>
  <input id="appName" placeholder="My Website App">
  <button id="buildBtn">Generate Android App</button>

  <div class="note">
    This will try a free builder API for an APK. If that fails (due to CORS or limits),
    it will automatically create a downloadable PWA ZIP that always works on GitHub Pages.
  </div>

  <div id="output" class="output hidden"></div>

<script>
const $ = id => document.getElementById(id);
const setOutput = html => { const o=$('output'); o.innerHTML=html; o.classList.remove('hidden'); };
function sanitizeUrl(u){ try{ const url=new URL(u); return url.href; }catch(e){ return null; } }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fileToArrayBuffer(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsArrayBuffer(f); }); }

async function createPwaZip(siteUrl, appName, includeIconFile){
  if(!window.JSZip){
    await new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js';
      s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
    });
  }
  const zip=new JSZip();
  const manifest={
    name: appName || (new URL(siteUrl)).hostname,
    short_name: (appName||'App').slice(0,12),
    start_url: siteUrl,
    display:"standalone",
    background_color:"#ffffff",
    theme_color:"#2563eb",
    icons:[]
  };
  if(includeIconFile) manifest.icons.push({src:'icon.png',sizes:'512x512',type:'image/png'});

  // ✅ The key fix: base href="./" so it works on GitHub Pages subpaths
  const indexHtml=`<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<base href="./">
<link rel="manifest" href="./manifest.json"><title>${escapeHtml(manifest.name)}</title>
<style>html,body{height:100%;margin:0}iframe{border:0;position:fixed;inset:0;width:100%;height:100%}</style>
</head><body><iframe src="${escapeHtml(siteUrl)}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{});</script></body></html>`;

  const swJs=`const CACHE='pwa-shell-v1';
self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','./index.html','./manifest.json','./sw.js']).catch(()=>{})));});
self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));
self.addEventListener('fetch',e=>{if(e.request.mode==='navigate'){e.respondWith(fetch(e.request).catch(()=>caches.match('./index.html')));return;}
e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});`;

  zip.file('index.html',indexHtml);
  zip.file('manifest.json',JSON.stringify(manifest,null,2));
  zip.file('sw.js',swJs);
  if(includeIconFile){
    try{const ab=await fileToArrayBuffer(includeIconFile);zip.file('icon.png',ab);}catch(e){}
  }
  zip.file('README.txt',`This is a PWA wrapper for ${siteUrl}.
Unzip & upload to GitHub Pages or any HTTPS host.
It will work even in a subfolder because of <base href="./"> fix.`);
  const blob=await zip.generateAsync({type:'blob',compression:'DEFLATE'});
  return blob;
}

$('buildBtn').onclick=async()=>{
  setOutput('Starting build...');
  const siteUrl=sanitizeUrl($('siteUrl').value.trim());
  if(!siteUrl){setOutput('Invalid URL (include https://)');return;}
  const appName=$('appName').value.trim()||'';
  const pkgId='com.site.'+(new URL(siteUrl)).hostname.replace(/\./g,'_');

  const endpoint='https://cloudapk.azurewebsites.net/generateAppPackage';
  const payload={webManifestUrl:siteUrl,appVersion:"1.0.0",appVersionCode:1,packageId:pkgId,signingMode:"none"};

  try{
    const resp=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!resp.ok) throw new Error('Builder blocked or unavailable');
    const blob=await resp.blob();
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`${(appName||'app')}_build.zip`;
    a.textContent='Download APK/AAB ZIP (click to save)';
    setOutput('<b>Success!</b> Your build is ready:<br>');
    $('output').appendChild(a);
  }catch(e){
    console.warn('APK build failed:',e);
    setOutput('⚠️ APK builder blocked or failed. Creating PWA ZIP instead...');
    const pwaBlob=await createPwaZip(siteUrl,appName);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(pwaBlob);
    a.download=`${(appName||'pwa').replace(/[^a-z0-9]/ig,'_')}_pwa.zip`;
    a.textContent='Download PWA ZIP (works anywhere)';
    $('output').innerHTML='<b>PWA ZIP ready!</b><br>';
    $('output').appendChild(a);
  }
};
</script>
</body>
</html>
